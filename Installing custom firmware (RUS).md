# Установка другой прошивки на Micromake D1

_Внимание_ - в качестве примера для этой инструкции используется плата Micromake первого поколения. Перемычкой на плате у меня установлен режим 32 steps. Настройки вашей платы могут отличаться. В качестве средства для отправки команд принтеру я использую Repetier Host. Если вы используете штатную программу CURA, ваши шаги будут немного отличаться.

Основная плата принтера Micromake - это переделанная Arduino Mega. Процессор тот же, основное отличие - только в том, что на плату добавили драйверы для шаговых моторов и силовые ключи для нагревательного элемента и хотбеда. Как и в любой Ардуине, в плату можно загрузить новую программу с компьютера через USB-шнур.

Для загрузки новой программы вам понадобится оболочка "Arduino IDE". Её можно бесплатно скачать с https://www.arduino.cc/en/Main/Software (вам нужна ссылка "Windows installer"). Скачайте программу и установите.

Далее - вам понадобится исходный код прошивки для принтера. Micromake работает на прошивке "Repetier" отсюда - https://github.com/repetier/Repetier-Firmware К сожалению, просто так взять её и накатить на принтер не получится - во-первых, она требует "доводки напильником" под наш принтер, во-вторых, будет не хватать добавленных китайцами дополнений.

Самый простой вариант - взять мой вариант прошивки с *URL*. Он сделан на базе бета-версии прошивки Repetier 1.0dev и кое-как работает. Или берите прошивку из официального хранилища Micromake на Гугл-диске - https://drive.google.com/drive/folders/0B1DQUrzkDP-tNDU0NXhVcGhlc0k (файл `Micromake D1.zip`).

Распакуйте файлы в любое место на диске - главное, чтобы папка с файлами имела имя `Repetier`. Например, пусть будет `c:\Repetier`. Откройте файл `Repetier.ino`.

Подключите плату USB-кабелем. В меню Arduino IDE `Tools` - `Board` выберите `Arduino/Genuino MEGA or MEGA 2560`. В меню `Tools` - `Port` выберите порт, который Windows присвоила подключённой плате. Уточнить его можно через "Диспетчер устройств" Windows.

Чтобы проверить, что всё скачано верно, нажмите `Ctrl+R`. В окне внизу побегут команды, и где-то через 10-15 секунд вы увидите сообщение `Done compining`, а внизу - отчёт вида 

    Sketch uses 137,236 bytes (54%) of program storage space. Maximum is 253,952 bytes.
    Global variables use 6,984 bytes (85%) of dynamic memory, leaving 1,208 bytes for local variables. Maximum is 8,192 bytes.
    Low memory available, stability problems may occur.

Это означает, что вы правильно установили Arduino IDE и правильно скачали прошивку.

## Настраиваем прошивку

В окне Arduino IDE будет много вкладок - по одной на каждый файл прошивки. Найдите вкладку с файлом `Commands.cpp` (не путайте с `Commands.h`!). Найдите строки:

    case 30:
        { // G30 single probe set Z0
            uint8_t p = (com->hasP() ? (uint8_t)com->P : 3);

вам нужно заменить `P : 3` на `P : 2`, то есть у вас получится:


    case 30:
        { // G30 single probe set Z0
            uint8_t p = (com->hasP() ? (uint8_t)com->P : 2);

В принципе, этой правки достаточно, чтобы с нашим принтером заработал OpenDACT. Если вы не хотите больше ничего менять, пропускайте следующий раздел.

## Ещё полезные поправки в прошивку

Раз мы с вами полезли в прошивку, давайте добавим улучшений. Переключитесь во вкладку `Configuration.h`. Нажимайте `Ctrl+H`, и копируйте название параметра, чтобы быстро его найти:

### STARTUP_GCODE

Задаёт команды, которые выполняются сразу по включении принтера. По умолчанию список пустой, у меня он такой (отдельные команды разделяются символами `\n`):

    #define STARTUP_GCODE "M115\nM119\nG28\nM140 S115\nM105 X0\n\n"

Поясню по отдельным командам:

| Команда | Что она делает: |
| --- | --- |
| M115 | Выводит в лог версию прошивки |
| M119 | Выводит в лог состояние концевых датчиков |
| G28 | Отправляет эффектор в домашнее положение |
| M140 S115 | Даёт команду на включение подогрева до 115 градусов |
| M105 X0 | Запрашивает у датчиков показания температуры |

Полный список команд есть на http://reprap.org/wiki/G-code

### Z_PROBE_REPETITIONS

По умолчанию значение этого параметра - единица, т.е. принтер делает только по одному замеру высоты в каждой точке. Поскольку Z-probe у нас фиговая, лучше пусть делает три замера и усредняет:

    #define Z_PROBE_REPETITIONS 3 // Repetitions for probing at one point.

### Z_PROBE_X1

Китайцы по какой-то причине не забили в прошивку правильные точки для автокалибровки принтера. Замените их на правильные (три пары значений, итого получается шесть строчек):

    #define Z_PROBE_X1 0
    #define Z_PROBE_Y1 65
    #define Z_PROBE_X2 64.95
    #define Z_PROBE_Y2 -37.5
    #define Z_PROBE_X3 -64.95
    #define Z_PROBE_Y3 -37.5


### BEEPER

Если хотите, чтобы принтер пищал потише, замените строчки следующими значениями:

    #define BEEPER_SHORT_SEQUENCE 1,1
    #define BEEPER_LONG_SEQUENCE 2,2

### Температура

Если у вас стол с подогревом, убедитесь, что в следующей строчке стоит не ноль, а единица:

    #define HAVE_HEATED_BED 1

Если вы хотите, чтобы по командам `Preheat ABS` или `Preheat PLA` в меню принтера выставлялась нестандартная температура, выставьте её тут. Например, я выставил температуру стола для ABS в 115 градусов, чтобы было с запасом:

    #define UI_SET_PRESET_HEATED_BED_TEMP_PLA 60
    #define UI_SET_PRESET_EXTRUDER_TEMP_PLA   200
    #define UI_SET_PRESET_HEATED_BED_TEMP_ABS 115
    #define UI_SET_PRESET_EXTRUDER_TEMP_ABS   245

### Правильная величина Delta diagonal rod

По какой-то причине китайцы запрограммировали в прошивке неверную длину диагоналей (210 вместо необходимых 217мм). Исправим это:

    // Delta settings
    #if DRIVE_SYSTEM==DELTA
    /** \brief Delta rod length (mm)
    */
    #define DELTA_DIAGONAL_ROD 217 // mm

### Правильная установка микрошага

Как я писал выше, мой принтер перемычкой на плате настроен на режим "32 микрошага". Этой настройке в прошивке отвечают параметры:

    /** \brief Steps per rotation of stepper motor */
    #define STEPS_PER_ROTATION 200

    /** \brief Micro stepping rate of X, Y and Y tower stepper drivers */
    #define MICRO_STEPS 32

- 200 шагов на оборот принтера, микрошаг равен 32. Если у вас принтер настроен по-другому, исправляйте тут.

### Замена текста на стартовом экране

Вместо "Micromake" на экране приветствия принтера можно выводить что-то своё. Текст можно поменять в строках:

    #define UI_PRINTER_NAME "Micromake 2.0.?"
    #define UI_PRINTER_COMPANY "www.micromake.org"

Рекомендую туда вписать что-то своё - так вы убедитесь, что в принтер встала ваша прошивка.

## Заливаем прошивку в принтер

*Внимание!* Перед заливкой новой прошивки сохраните настройки принтера (в файл, на бумажку - как угодно).

После того, как вы всё отредактировали, нажимайте `Ctrl+U`. Прошивка скомпилируется, потом в течение 10-20 секунад зальётся в принтер. 

## Как вернуть всё как было, если всё сломалось

Откройте CURA и залейте в принтер заводскую прошивку.
